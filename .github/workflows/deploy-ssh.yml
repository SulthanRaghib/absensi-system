name: üöÄ Advanced Deploy via SSH

on:
  push:
    branches:
      - master # Sesuaikan dengan branch utama Anda

jobs:
  deploy:
    name: üöß Build & Deploy to Server
    runs-on: ubuntu-latest

    steps:
      # 1. Ambil Kodingan Terbaru
      - name: üöö Checkout Code
        uses: actions/checkout@v4

      # 2. Setup PHP & Install Composer Dependencies
      # Penting: Composer install harus dilakukan SEBELUM npm run build
      # karena Filament membutuhkan file CSS dari folder vendor/
      - name: üîµ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"

      - name: üß∂ Install Composer Dependencies (Local)
        run: composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

      # 3. Setup Node.js untuk Build Frontend (Vite/Tailwind)
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì¶ Install NPM & Build Assets
        run: |
          npm install
          npm run build

      # 4. Siapkan SSH Key di Runner Sementara
      - name: üîë Configure SSH
        run: |
          mkdir -p ~/.ssh/
          # Menggunakan printf untuk menangani newline dengan lebih baik
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Debug: Cek format key (Header & Footer saja agar aman)
          echo "Checking Key Format..."
          head -n 1 ~/.ssh/deploy_key
          tail -n 1 ~/.ssh/deploy_key

      # DEBUGGING
      - name: üîç Debug Secrets (Check Empty)
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "‚ùå Error: Secret SSH_HOST is empty"; exit 1; fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then echo "‚ùå Error: Secret SSH_USER is empty"; exit 1; fi
          if [ -z "${{ secrets.TARGET_DIR }}" ]; then echo "‚ùå Error: Secret TARGET_DIR is empty"; exit 1; fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "‚ùå Error: Secret SSH_PRIVATE_KEY is empty"; exit 1; fi
          echo "‚úÖ All required secrets are present!"

      # 5. Kirim File menggunakan RSYNC (Cepat & Cerdas)
      - name: üì§ Rsync Deploy to Server
        run: |
          echo "üöÄ Starting deployment to ${{ secrets.SSH_HOST }}..."

          # Test koneksi SSH dulu sebelum rsync
          ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo '‚úÖ SSH Connection Successful'"

          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='node_modules/' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/views/*' \
            --exclude='storage/logs/*' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}

      # 6. Eksekusi Perintah Laravel di Server (Remote Command)
      # Ini bagian 'Advanced'-nya: Migrate & Optimize otomatis!
      - name: üöÄ Run Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.TARGET_DIR }}

            # --- 1. DEFINISI PHP 8.3 (DirectAdmin) ---
            PHP_BIN="/usr/local/php83/bin/php"

            # --- 2. HAPUS CACHE MANUAL (CRUCIAL STEP!) ---
            # Kita hapus cache lama secara paksa agar tidak error "Class not found"
            # Ini menghapus config.php, packages.php, services.php di folder cache
            echo "üî• Nuking old bootstrap cache..."
            rm -f bootstrap/cache/*.php

            # --- 3. MAINTENANCE MODE ---
            # Gunakan '|| true' agar jika gagal, script tetap lanjut
            $PHP_BIN artisan down --render="errors::503" || true

            # --- 4. INSTALL DEPENDENCIES ---
            echo "üì¶ Installing Dependencies..."
            # Hapus composer.phar lama jika ada biar fresh
            rm -f composer.phar
            curl -sS https://getcomposer.org/installer | $PHP_BIN

            # Install tanpa dev dependencies
            $PHP_BIN composer.phar install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # --- 5. MIGRASI DATABASE ---
            echo "üöÄ Running Migrations..."
            # Paksa migrasi
            $PHP_BIN artisan migrate --force

            # --- 6. BUILD ULANG CACHE ---
            echo "üßπ Re-building Cache..."
            # Karena cache file sudah dihapus di step 2, perintah ini harusnya sekarang berhasil
            $PHP_BIN artisan optimize:clear
            $PHP_BIN artisan config:cache
            $PHP_BIN artisan event:cache
            $PHP_BIN artisan route:cache
            $PHP_BIN artisan view:cache
            $PHP_BIN artisan filament:optimize

            # --- 7. STORAGE LINK ---
            $PHP_BIN artisan storage:link

            # --- 8. ONLINE KEMBALI ---
            $PHP_BIN artisan up

            # Bersihkan jejak
            rm -f composer.phar

            echo "‚úÖ Deployment Successfully Finished!"
