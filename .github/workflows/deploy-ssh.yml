name: ðŸš€ Advanced Deploy via SSH

on:
  push:
    branches:
      - master # Sesuaikan dengan branch utama Anda

jobs:
  deploy:
    name: ðŸš§ Build & Deploy to Server
    runs-on: ubuntu-latest

    steps:
      # 1. Ambil Kodingan Terbaru
      - name: ðŸšš Checkout Code
        uses: actions/checkout@v4

      # 2. Setup PHP & Install Composer Dependencies
      # Penting: Composer install harus dilakukan SEBELUM npm run build
      # karena Filament membutuhkan file CSS dari folder vendor/
      - name: ðŸ”µ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"

      - name: ðŸ§¶ Install Composer Dependencies (Local)
        run: composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

      # 3. Setup Node.js untuk Build Frontend (Vite/Tailwind)
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“¦ Install NPM & Build Assets
        run: |
          npm install
          npm run build

      # 4. Siapkan SSH Key di Runner Sementara
      - name: ðŸ”‘ Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          cat >>~/.ssh/config <<END
          Host production
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            Port ${{ secrets.SSH_PORT }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          END

      # DEBUGGING
      - name: ðŸ” Debug Secrets (Check Empty)
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "âŒ Error: Secret SSH_HOST is empty"; exit 1; fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then echo "âŒ Error: Secret SSH_USER is empty"; exit 1; fi
          if [ -z "${{ secrets.TARGET_DIR }}" ]; then echo "âŒ Error: Secret TARGET_DIR is empty"; exit 1; fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then echo "âŒ Error: Secret SSH_PRIVATE_KEY is empty"; exit 1; fi
          echo "âœ… All required secrets are present!"

      # 5. Kirim File menggunakan RSYNC (Cepat & Cerdas)
      # Mengirim folder 'public/build' (hasil npm run build) dan code lainnya
      # Mengecualikan file yang tidak perlu atau file sensitif (.env)
      - name: ðŸ“¤ Rsync Deploy to Server
        run: |
          rsync -avz --delete \
            -e "ssh -vvv -p ${{ secrets.SSH_PORT }} -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='node_modules/' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/views/*' \
            --exclude='storage/logs/*' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}

      # 6. Eksekusi Perintah Laravel di Server (Remote Command)
      # Ini bagian 'Advanced'-nya: Migrate & Optimize otomatis!
      - name: ðŸš€ Run Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.TARGET_DIR }}

            # Matikan aplikasi sebentar (Maintenance Mode)
            php artisan down --render="errors::503" || true

            # Install dependency PHP di server (memastikan kecocokan platform)
            # Jika hosting membatasi RAM, tambahkan flag --ignore-platform-reqs jika perlu
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # Jalankan Migrasi Database
            php artisan migrate --force

            # Bersihkan dan Cache Konfigurasi
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan filament:optimize # Khusus Filament v3/v4

            # Storage Link (Hanya perlu sekali, tapi aman dijalankan ulang)
            php artisan storage:link

            # Nyalakan kembali aplikasi
            php artisan up

            echo "âœ… Deployment Successfully Finished!"
